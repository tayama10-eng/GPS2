<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>GeoSim JP â€” Ultra+ Realism (3-file PWA)</title>
<link rel="manifest" href="manifest.json">
<style>
*{box-sizing:border-box}body{margin:0;background:#0e1217;color:#e8ecf1;
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans JP',sans-serif}
header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px 12px;background:#121826;border-bottom:1px solid #1f2633}
h1{font-size:18px;margin:0}.sub{opacity:.8}.actions{display:flex;gap:8px;flex-wrap:wrap}
button{border:1px solid #2a3446;background:#17202e;color:#e8ecf1;padding:6px 10px;border-radius:8px;cursor:pointer}
button:hover{filter:brightness(1.1)}
select, input{border:1px solid #2a3446;background:#101927;color:#e8ecf1;padding:6px 8px;border-radius:8px}
#tabs{display:flex;gap:6px;flex-wrap:wrap;padding:8px 12px;background:#0b1118;border-bottom:1px solid #1f2633}
#tabs button{background:#101927;border:1px solid #1e293b}
#status{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:8px;padding:8px 12px;background:#0b1118;border-bottom:1px solid #1f2633}
#status>div{background:#101927;border:1px solid #1e293b;padding:6px 8px;border-radius:8px}
#panels{padding:12px}.panel{display:none}.panel.active{display:block}
.card{background:#101927;border:1px solid #1e293b;border-radius:10px;padding:12px;margin-bottom:12px}
.card h2{margin:0 0 8px 0;color:#9ecbff;font-size:16px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px;white-space:pre-wrap}
.small{font-size:12px;opacity:.9}
#log{padding:12px}.logbox{background:#0b1118;border:1px solid #1e293b;border-radius:10px;padding:12px;max-height:280px;overflow:auto;
  font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
.badge{display:inline-block;padding:2px 6px;border-radius:6px;background:#1a2738;border:1px solid #2a3950;margin-left:6px}
</style>
</head>
<body>
<header>
  <div>
    <h1>GeoSim â€” Ultra+ Realism</h1>
    <div class="sub small">å››åŠæœŸã‚¿ãƒ¼ãƒ³ï¼ãƒ‡ãƒ¼ã‚¿é§†å‹•ï¼ˆä¸–ç•Œä¸­ã®å›½ã‚’è¿½åŠ å¯ï¼‰ï¼éç·šå½¢å¸‚å ´ï¼å¤–äº¤AIï¼PWAï¼Monte Carlo</div>
  </div>
  <div class="actions">
    <label class="small">Country:
      <select id="countrySel"></select>
    </label>
    <button id="runQuarter">â–¶ æ¬¡ã®å››åŠæœŸ</button>
    <button id="runYear">â­ 1å¹´(4Q)</button>
    <button id="mc">ğŸ² Monte Carlo</button>
    <button id="save">ğŸ’¾ ä¿å­˜</button>
    <button id="load">ğŸ“‚ èª­è¾¼</button>
    <button id="reset">ğŸ—‘ æ–°è¦</button>
  </div>
</header>

<nav id="tabs"></nav>
<section id="status"></section>
<main id="panels"></main>
<section id="log"></section>

<script type="module">
/* =========================================================
   0) ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ & ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆå°†æ¥ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¯ï¼‰
========================================================= */
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const rnd=()=>Math.random();

const P = { // æ¨å®šãƒ»æ ¡æ­£ã§ä¸Šæ›¸ãå¯
  rstar:0.30, termPremBase:0.25, termPremDebtK:0.28, termPremVolK:0.10,
  yccCap:2.0, fxRiskK:2.0, expInflInertia:0.75, expInflFromCPI:0.20, expInflNoise:0.05,
  energyLngK:0.12, energyFxK:0.04, energyNukeK:-0.02, energyRenewK:-0.01, energyCarbonK:0.002,
  supplyFriction:0.25, exportFxK:0.16, sentimentK:0.28, geoPenaltyK:0.12,
  priceInertia:0.5, priceFromEnergy:0.2, priceFromFX:0.2, priceFromGap:0.2, priceFromCarbon:0.1,
  okun:0.18, revenueElastic:0.40, debtRatePass:0.25,
  credPBPos:+1.0, credPBNegBig:-1.5, credSupplyK:-0.2
};

/* =========================================================
   1) å›½ãƒ‡ãƒ¼ã‚¿ï¼ˆç„¡é™æ‹¡å¼µå¯ï¼‰â€” ä¾‹ï¼šã‚¢ã‚¸ã‚¢/æ¬§å·/ç±³å·/ã‚¢ãƒ•ãƒªã‚«/ä¸­æ±
   â€» æ–°ã—ã„å›½ã¯ã“ã®é…åˆ—ã«è¿½è¨˜ã™ã‚‹ã ã‘ã§OKï¼ˆå°†æ¥CSV/GeoJSONã«ç½®æ›å¯ï¼‰
========================================================= */
const countries = [
  { iso3:"JPN", name:"Japan", currency:"JPY", fx_regime:"free_floating",
    pop:{total_m:124.0, tfr:1.28, aging_idx:1.8, net_immig_pa:0.12},
    labor:{union:0.17, participation:0.63},
    fiscal:{vat:0.10, corp:0.30, pit_top:0.45, pension_gdp:0.10, health_gdp:0.08},
    debt:{gross_gdp:2.6, fx_share:0.03, maturity_y:8.7},
    energy:{mix:{lng:0.36,coal:0.27,oil:0.07,nuke:0.06,renew:0.24}, carbon_price:20, reserve_m:7.0},
    trade:{x_gdp:0.18, m_gdp:0.17, partners:{"USA":0.20,"CHN":0.20,"EUU":0.12}},
    defense:{gdp:0.02, readiness:0.62, deterrence:0.68},
    politics:{stability:0.65, bureau:0.75, factions:0.70, local:0.80},
    media:{bias:-0.05, vol:0.15},
    hazard:{typhoon:0.6,flood:0.5,heat:0.4,quake:0.8},
    diplomacy:{relations:{"USA":0.75,"CHN":0.40,"KOR":0.65,"PRK":0.20}, repute:0.64}
  },
  { iso3:"USA", name:"United States", currency:"USD", fx_regime:"free_floating",
    pop:{total_m:335.0, tfr:1.66, aging_idx:1.3, net_immig_pa:1.2},
    labor:{union:0.10, participation:0.62},
    fiscal:{vat:0.00, corp:0.21, pit_top:0.37, pension_gdp:0.06, health_gdp:0.17},
    debt:{gross_gdp:1.2, fx_share:1.00, maturity_y:6.1},
    energy:{mix:{gas:0.39,coal:0.19,oil:0.01,nuke:0.18,renew:0.23}, carbon_price:0, reserve_m:30.0},
    trade:{x_gdp:0.12, m_gdp:0.15, partners:{"CHN":0.17,"MEX":0.14,"CAN":0.14}},
    defense:{gdp:0.035, readiness:0.75, deterrence:0.80},
    politics:{stability:0.55, bureau:0.60, factions:0.55, local:0.70},
    media:{bias:0.00, vol:0.20},
    hazard:{hurricane:0.6,flood:0.4,heat:0.5,quake:0.4,fire:0.5},
    diplomacy:{relations:{"JPN":0.78,"CHN":0.35,"EUU":0.70}, repute:0.70}
  },
  { iso3:"CHN", name:"China", currency:"CNY", fx_regime:"managed_float",
    pop:{total_m:1410.0, tfr:1.15, aging_idx:1.4, net_immig_pa:-0.1},
    labor:{union:0.50, participation:0.67},
    fiscal:{vat:0.13, corp:0.25, pit_top:0.45, pension_gdp:0.08, health_gdp:0.06},
    debt:{gross_gdp:0.9, fx_share:0.07, maturity_y:7.0},
    energy:{mix:{coal:0.60,gas:0.08,oil:0.03,nuke:0.05,renew:0.24}, carbon_price:8, reserve_m:40.0},
    trade:{x_gdp:0.20, m_gdp:0.17, partners:{"USA":0.17,"EUU":0.16,"ASE":0.14}},
    defense:{gdp:0.018, readiness:0.65, deterrence:0.70},
    politics:{stability:0.75, bureau:0.80, factions:0.50, local:0.70},
    media:{bias:0.10, vol:0.12},
    hazard:{flood:0.5,heat:0.5,quake:0.5},
    diplomacy:{relations:{"JPN":0.40,"USA":0.35,"RUS":0.70}, repute:0.55}
  },
  { iso3:"DEU", name:"Germany", currency:"EUR", fx_regime:"eurozone",
    pop:{total_m:84.5, tfr:1.50, aging_idx:1.6, net_immig_pa:0.5},
    labor:{union:0.17, participation:0.61},
    fiscal:{vat:0.19, corp:0.30, pit_top:0.45, pension_gdp:0.10, health_gdp:0.11},
    debt:{gross_gdp:0.67, fx_share:0.00, maturity_y:7.0},
    energy:{mix:{gas:0.20,coal:0.20,nuke:0.00,renew:0.50,oil:0.10}, carbon_price:90, reserve_m:10.0},
    trade:{x_gdp:0.43, m_gdp:0.40, partners:{"EUU":0.55,"CHN":0.08,"USA":0.08}},
    defense:{gdp:0.015, readiness:0.55, deterrence:0.60},
    politics:{stability:0.70, bureau:0.80, factions:0.60, local:0.70},
    media:{bias:-0.02, vol:0.12},
    hazard:{flood:0.4,heat:0.4},
    diplomacy:{relations:{"JPN":0.70,"USA":0.70,"CHN":0.45}, repute:0.75}
  },
  { iso3:"IND", name:"India", currency:"INR", fx_regime:"managed_float",
    pop:{total_m:1420.0, tfr:2.0, aging_idx:0.9, net_immig_pa:-0.2},
    labor:{union:0.12, participation:0.48},
    fiscal:{vat:0.18, corp:0.25, pit_top:0.30, pension_gdp:0.05, health_gdp:0.04},
    debt:{gross_gdp:0.82, fx_share:0.05, maturity_y:6.5},
    energy:{mix:{coal:0.53,gas:0.06,oil:0.03,nuke:0.03,renew:0.35}, carbon_price:0, reserve_m:20.0},
    trade:{x_gdp:0.20, m_gdp:0.24, partners:{"USA":0.12,"CHN":0.11,"EUU":0.11}},
    defense:{gdp:0.025, readiness:0.60, deterrence:0.65},
    politics:{stability:0.60, bureau:0.60, factions:0.55, local:0.70},
    media:{bias:-0.02, vol:0.18},
    hazard:{heat:0.6,flood:0.5,drought:0.5},
    diplomacy:{relations:{"USA":0.60,"RUS":0.65,"CHN":0.35}, repute:0.60}
  },
  // â€¦å¿…è¦ã«å¿œã˜ã¦å¥½ããªã ã‘è¿½è¨˜
];

/* =========================================================
   2) å˜ä¸€ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆpreâ†’stepâ†’postï¼‰+ Monte Carlo
========================================================= */
function baseState(country){
  const c = countries.find(x=>x.iso3===country) || countries[0];
  return {
    q:0, iso3:c.iso3, name:c.name, currency:c.currency, fx_regime:c.fx_regime,
    // macro
    gdp: Math.max(50, c.pop.total_m*4.5), gdp_prev: Math.max(50, c.pop.total_m*4.5),
    cpi: 2.0, unemp: 4.5,
    // markets
    fx: 100, y10: 1.0, expInfl: 2.0, termPrem: 0.4, cred: 60,
    // fiscal
    debt: 0.9* (Math.max(50, c.pop.total_m*4.5)), revenue: 0.2* (Math.max(50, c.pop.total_m*4.5)),
    expend: 0.22* (Math.max(50, c.pop.total_m*4.5)), pb: 0,
    // structures
    politics: c.politics, media: c.media,
    // sectors & linkages
    energy: { mix: c.energy.mix, carbon: c.energy.carbon_price, reserve: c.energy.reserve_m, elecCost: 30 },
    supply: { constraint: 0.12 },
    trade: { x_gdp:c.trade.x_gdp, m_gdp:c.trade.m_gdp, partners:c.trade.partners, terms:100 },
    demog: { pop:c.pop.total_m, tfr:c.pop.tfr, aging:c.pop.aging_idx, immig:c.pop.net_immig_pa, wageNom:1.0 },
    defense: c.defense,
    diplo: { relations: JSON.parse(JSON.stringify(c.diplomacy.relations||{})), repute:c.diplomacy.repute||0.6, escalation:0 },
    _log:[]
  };
}
class Engine{
  constructor(countryIso){ this.S = baseState(countryIso); this.mods=[]; this.log=(m)=>{this.S._log.unshift(m); if(this.S._log.length>800)this.S._log.pop();}; }
  register(m){ m.attach?.(this); this.mods.push(m); }
  reset(countryIso){ this.S = baseState(countryIso||this.S.iso3); }
  step(){ this.mods.forEach(m=>m.pre?.(this.S,this.log)); this.mods.forEach(m=>m.step?.(this.S,this.log)); this.mods.forEach(m=>m.post?.(this.S,this.log)); this.S.q++; }
  monteCarlo(q=12, n=200){ const base=JSON.parse(JSON.stringify(this.S)); const out=[]; for(let t=0;t<n;t++){ this.S=JSON.parse(JSON.stringify(base)); for(let i=0;i<q;i++)this.step(); out.push({fx:this.S.fx,cpi:this.S.cpi,y10:this.S.y10,gdp:this.S.gdp,debt:this.S.debt}); } const stat=a=>{const s=[...a].sort((x,y)=>x-y), n=a.length; return {mean:a.reduce((p,c)=>p+c,0)/n,p10:s[Math.floor(n*0.1)],p50:s[Math.floor(n*0.5)],p90:s[Math.floor(n*0.9)]};}; const res={fx:stat(out.map(o=>o.fx)), cpi:stat(out.map(o=>o.cpi)), y10:stat(out.map(o=>o.y10)), gdp:stat(out.map(o=>o.gdp)), debt:stat(out.map(o=>o.debt))}; this.S=base; this.log(`ğŸ² MC(${n}) FX p10/50/90 ${res.fx.p10.toFixed(0)}/${res.fx.p50.toFixed(0)}/${res.fx.p90.toFixed(0)}`); return res; }
}

/* =========================================================
   3) ãƒ¢ãƒ‡ãƒ«ç¾¤ï¼ˆéç·šå½¢å¸‚å ´ï¼ãƒã‚¯ãƒ­ï¼ã‚¨ãƒãƒ«ã‚®ãƒ¼ï¼äººå£ï¼é€šå•†ï¼å¤–äº¤AIï¼ç½å®³ãƒ»æ°—å€™ï¼‰
========================================================= */
class Prices{
  pre(S,log){
    // æœŸå¾…ã‚¤ãƒ³ãƒ•ãƒ¬
    S.expInfl = clamp(P.expInflInertia*S.expInfl + P.expInflFromCPI*S.cpi + P.expInflNoise*(rnd()*4-2), -0.5, 8);
    // ã‚¿ãƒ¼ãƒ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ï¼ˆå‚µå‹™/ãƒœãƒ©ï¼‰
    const debtR = S.debt / S.gdp, vol = Math.abs((S.fx||100)-100)/40;
    S.termPrem = clamp(P.termPremBase + P.termPremDebtK*Math.max(0,debtR-1.5) + P.termPremVolK*vol, 0.1, 1.8);
    // é•·æœŸé‡‘åˆ©ï¼ˆéç·šå½¢ãƒªã‚¹ã‚¯ï¼‰
    const credShock = Math.max(0,(65 - S.cred)/65);
    S.y10 = clamp(P.rstar + S.expInfl + S.termPrem + 0.8*credShock*credShock, 0.1, P.yccCap);
    // ç‚ºæ›¿ï¼ˆUIP+ãƒªã‚¹ã‚¯+åœ°æ”¿ï¼‰
    const rateDiff = (S.y10 - 1.0);
    const credTerm = (60 - S.cred)*0.25;
    const geoTerm = Object.values(S.diplo.relations).reduce((a,v)=>a+(0.5-v),0)*4 + (S.diplo.escalation*1.5);
    const riskPrem = P.fxRiskK*Math.pow(Math.max(0,(S.debt/S.gdp)-1.5), 1.2);
    const shock = (rnd()-0.5)*2*(1 + 0.5*Math.abs(rateDiff));
    S.fx = clamp((S.fx||100) + 1.2*rateDiff + credTerm + geoTerm + riskPrem + shock, 50, 400);
  }
}
class Energy{
  step(S,log){
    const mix=S.energy.mix||{}, lng= (mix.lng||mix.gas||0)*100;
    S.energy.elecCost = clamp(28 + P.energyLngK*(lng-12) + P.energyFxK*((S.fx||100)-100) + P.energyNukeK*(mix.nuke||0)*100 + P.energyRenewK*((mix.renew||0)*100-30) + P.energyCarbonK*(S.energy.carbon||0), 20, 120);
    S.energy.reserve = clamp((S.energy.reserve||6.0) - 0.05 + ((mix.nuke||0)>0?0.05:0), 1.0, 60.0);
  }
}
class Macro{
  step(S,log){
    const energyPenalty = 0.18*(S.energy.elecCost-30)/10 + 0.02*((S.energy.carbon||0)/1000);
    const supplyPenalty = P.supplyFriction*(S.supply.constraint||0.12);
    const fxExport      = P.exportFxK*(120 - (S.fx||100))/40;
    const sentiment     = P.sentimentK*((S.cred||60)-60)/50;
    const geoPenalty    = P.geoPenaltyK*(S.diplo.escalation||0);
    const g = sentiment + fxExport - energyPenalty - supplyPenalty - geoPenalty;

    // CPI / å¤±æ¥­
    const cpi = clamp(P.priceInertia*S.cpi + P.priceFromEnergy*(S.energy.elecCost-30)/6 + P.priceFromFX*((S.fx||100)-100)/30 + P.priceFromGap*g + P.priceFromCarbon*((S.energy.carbon||0)/1000), -2, 15);
    const un  = clamp(S.unemp - P.okun*g + 0.15*(S.supply.constraint||0.12), 2, 20);

    // è²¡æ”¿
    const rev = clamp(S.revenue*(1 + P.revenueElastic*g/4), 0, S.gdp*0.6);
    const rigid = 0.18*S.gdp + 0.02*(S.demog.aging||1.0)*S.gdp; // å¹´é‡‘ãƒ»åŒ»ç™‚ç­‰ã–ã£ãã‚Š
    const exp  = clamp(rigid + 0.04*S.gdp, 0, S.gdp*0.9);
    const pb   = rev - exp;
    const debt = Math.max(0, S.debt + (-pb) + P.debtRatePass*S.y10);

    // åæ˜ 
    S.gdp_prev=S.gdp; S.gdp=clamp(S.gdp*(1+g/4), S.gdp*0.8, S.gdp*1.2);
    S.cpi=cpi; S.unemp=un; S.revenue=rev; S.expend=exp; S.pb=pb; S.debt=debt;

    // ä¿¡èª
    const fisc = pb < -0.02*S.gdp ? P.credPBNegBig : (pb>0 ? P.credPBPos : -0.2);
    S.cred = clamp((S.cred||60) + fisc - 0.2*(S.supply.constraint||0.12), 10, 95);

    log(`æˆé•·(å¹´ç‡) ${(g*100).toFixed(1)}% / CPI ${cpi.toFixed(1)}% / PB ${(pb).toFixed(1)}`);
  }
}
class Demography{
  post(S,log){
    const births = S.demog.pop * (S.demog.tfr/2.1) * 0.006;
    const deaths = S.demog.pop * 0.008 * (S.demog.aging||1.0)/1.6;
    const immig  = (S.demog.immig||0)/10.0;
    S.demog.pop = Math.max(1, S.demog.pop + births - deaths + immig);
    S.demog.wageNom = clamp(S.demog.wageNom*(1 + 0.20*(S.cpi/100)), 0.4, 5.0);
  }
}
class Trade{
  step(S,log){
    S.trade.terms = clamp(100 - 0.08*(S.energy.elecCost-30) - 0.05*((S.fx||100)-100), 80, 120);
  }
}
// å¤šå›½å¤–äº¤AIï¼šå…¨ãƒšã‚¢ã§C/D/Mã‚’åŒæ™‚é¸æŠâ†’é–¢ä¿‚/è©•åˆ¤/ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°
class Geopolitics{
  step(S,log){
    const keys = Object.keys(S.diplo.relations||{});
    const moves = {};
    keys.forEach(k=>{
      const rel = S.diplo.relations[k]??0.5;
      const e = S.diplo.escalation||0;
      const pC = clamp(0.55 + (rel-0.5)/2 - e/12, 0.05, 0.90);
      const pM = clamp(0.10 + e/14, 0.02, 0.45);
      const r = rnd(); moves[k] = r<pC ? 'C' : (r<pC+pM ? 'M' : 'D');
    });
    // é–¢ä¿‚æ›´æ–°
    for(const k of keys){
      const A = moves[k], payA = A==='C'?{eco:+2,sec:+1,rep:+1}:A==='M'?{eco:0,sec:+1,rep:-1}:{eco:-1,sec:0,rep:-1};
      const relOld = S.diplo.relations[k]??0.5;
      const relNew = clamp(relOld + 0.04*payA.sec + 0.02*payA.rep + (payA.eco>0?0.01:0), 0, 1);
      S.diplo.relations[k] = relNew;
    }
    const score = Object.values(moves).reduce((a,v)=>a+(v==='C'?-1:(v==='M'?+1:+2)),0);
    S.diplo.escalation = clamp((S.diplo.escalation||0) + (score>keys.length/3?+1:(score<-keys.length/3?-1:0)), 0, 4);
    S.diplo.repute = clamp((S.diplo.repute||0.6) + (score<0?+0.01:-0.01), 0, 1);
    if(keys.length && rnd()<0.2) log(`å¤–äº¤: ${S.name} moves ${JSON.stringify(moves)}`);
  }
}
class Disasters{
  step(S,log){
    const r=rnd();
    if(r<0.04){ log("âš  åŸææ–™é«˜"); S.energy.reserve=Math.max(1.0,(S.energy.reserve||6)-0.5); S.energy.carbon=(S.energy.carbon||0)+5; }
    else if(r<0.07){ log("âš  æ´ªæ°´/å°é¢¨"); S.supply.constraint=clamp((S.supply.constraint||0.12)+0.04,0.05,0.6); }
    else if(r<0.10){ log("âœ“ ITå¾ªç’°è¿½ã„é¢¨"); S.gdp=Math.min(S.gdp*1.01, S.gdp_prev*1.2); }
  }
}
class Climate{
  post(S,log){ if(rnd()<0.15){ S.energy.carbon = (S.energy.carbon||0) + 5; } }
}

/* =========================================================
   4) UIï¼ˆã‚¿ãƒ–ãƒ»è¡¨ç¤ºãƒ»æ“ä½œï¼‰
========================================================= */
const tabs = [
  ['dashboard','ğŸ“Š Dashboard'],['markets','ğŸ¦ å¸‚å ´'],['energy','âš¡ ã‚¨ãƒãƒ«ã‚®ãƒ¼'],
  ['demog','ğŸ‘¥ äººå£'],['trade','ğŸš¢ é€šå•†'],['diplomacy','ğŸ¤ å¤–äº¤'],['risk','ğŸ² ãƒªã‚¹ã‚¯'],['log','ğŸ§¾ ãƒ­ã‚°']
];
function initUI(engine){
  const sel = document.getElementById('countrySel');
  sel.innerHTML = countries.map(c=>`<option value="${c.iso3}">${c.name}</option>`).join('');
  sel.value = engine.S.iso3;
  sel.onchange = ()=>{ engine.reset(sel.value); renderTop(engine); renderPanels(engine); renderLog(engine); };

  const tEl = document.getElementById('tabs');
  tEl.innerHTML = tabs.map(([id,lab])=>`<button data-tab="${id}">${lab}</button>`).join('');
  tEl.querySelectorAll('button').forEach(b=>b.onclick=()=>switchTab(b.dataset.tab));

  const pEl = document.getElementById('panels');
  pEl.innerHTML = tabs.map(([id])=>`<section class="panel" id="p-${id}"></section>`).join('');
  switchTab('dashboard');

  document.getElementById('runQuarter').onclick=()=>{ engine.step(); renderTop(engine); renderPanels(engine); renderLog(engine); };
  document.getElementById('runYear').onclick=()=>{ for(let i=0;i<4;i++) engine.step(); renderTop(engine); renderPanels(engine); renderLog(engine); };
  document.getElementById('mc').onclick=()=>{ const r=engine.monteCarlo(12,200); renderLog(engine,`ğŸ² FX p10/50/90 ${r.fx.p10.toFixed(0)}/${r.fx.p50.toFixed(0)}/${r.fx.p90.toFixed(0)}`); };
  document.getElementById('save').onclick=()=>{ localStorage.setItem('geosim_ultra_save', JSON.stringify(engine.S)); renderLog(engine,"ğŸ’¾ ä¿å­˜ã—ã¾ã—ãŸ"); };
  document.getElementById('load').onclick=()=>{ const raw=localStorage.getItem('geosim_ultra_save'); if(raw){ engine.S=JSON.parse(raw); renderTop(engine); renderPanels(engine); renderLog(engine,"ğŸ“‚ èª­è¾¼ã—ã¾ã—ãŸ"); } };
  document.getElementById('reset').onclick=()=>{ engine.reset(); renderTop(engine); renderPanels(engine); renderLog(engine,"ğŸ—‘ æ–°è¦"); };
}
function switchTab(id){ document.querySelectorAll('.panel').forEach(el=>el.classList.remove('active')); document.getElementById('p-'+id).classList.add('active'); }
function renderTop(engine){
  const S=engine.S, st=document.getElementById('status');
  const rows = [
    ['æœŸ', `${(S.q%4)+1} / Y${Math.floor(S.q/4)+1}`],
    ['GDP(å…†ç›¸å½“)', S.gdp.toFixed(1)], ['CPI(%)', S.cpi.toFixed(1)], ['å¤±æ¥­(%)', S.unemp.toFixed(1)],
    ['10Y(%)', S.y10.toFixed(2)], ['ç‚ºæ›¿(åŸºæº–=100)', (S.fx||100).toFixed(0)],
    ['PB(å…†)', S.pb.toFixed(1)], ['å‚µå‹™/GDP', (S.debt/S.gdp).toFixed(2)],
    ['ä¿¡èª', S.cred.toFixed(0)], ['é›»åŠ›ã‚³ã‚¹ãƒˆ', S.energy.elecCost.toFixed(1)],
    ['äº¤æ˜“æ¡ä»¶', (S.trade.terms||100).toFixed(0)], ['å¤–äº¤Esc.', (S.diplo.escalation||0)]
  ];
  st.innerHTML = rows.map(([k,v])=>`<div>${k}: <b>${v}</b></div>`).join('');
}
function renderPanels(engine){
  const S=engine.S;
  document.getElementById('p-dashboard').innerHTML = `
    <div class="grid">
      <div class="card"><h2>æ¦‚è¦</h2>
        <div class="mono">å›½: ${S.name} (${S.iso3}) / é€šè²¨: ${S.currency} / ä½“åˆ¶: ${S.fx_regime}</div>
        <div class="mono">äººå£: ${S.demog.pop.toFixed(1)}M / TFR: ${S.demog.tfr} / é«˜é½¢åŒ–Idx: ${S.demog.aging}</div>
        <div class="mono">æ”¿æ²»å®‰å®š: ${(S.politics?.stability??0)*100|0} / å®˜åƒš:${(S.politics?.bureau??0)*100|0} / åœ°æ–¹:${(S.politics?.local??0)*100|0}</div>
        <div class="mono">ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: ${S.diplo.escalation} / äºˆå‚™: ${S.energy.reserve.toFixed(1)}</div>
      </div>
    </div>`;
  document.getElementById('p-markets').innerHTML = `
    <div class="grid">
      <div class="card"><h2>å¸‚å ´</h2>
        <div class="mono">æœŸå¾…ã‚¤ãƒ³ãƒ•ãƒ¬: ${S.expInfl.toFixed(2)} / ã‚¿ãƒ¼ãƒ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ : ${S.termPrem.toFixed(2)} / ä¿¡èª: ${S.cred.toFixed(0)}</div>
        <div class="mono">10å¹´é‡‘åˆ©: ${S.y10.toFixed(2)} / ç‚ºæ›¿: ${(S.fx||100).toFixed(0)}</div>
      </div>
    </div>`;
  document.getElementById('p-energy').innerHTML = `
    <div class="grid">
      <div class="card"><h2>ã‚¨ãƒãƒ«ã‚®ãƒ¼</h2>
        <div class="mono">é›»æºãƒŸãƒƒã‚¯ã‚¹: ${JSON.stringify(S.energy.mix)}</div>
        <div class="mono">ç‚­ç´ : ${S.energy.carbon||0} / äºˆå‚™: ${S.energy.reserve.toFixed(1)} / ã‚³ã‚¹ãƒˆ: ${S.energy.elecCost.toFixed(1)}</div>
      </div>
    </div>`;
  document.getElementById('p-demog').innerHTML = `
    <div class="grid">
      <div class="card"><h2>äººå£</h2>
        <div class="mono">äººå£: ${S.demog.pop.toFixed(1)}M / è³ƒé‡‘æŒ‡æ•°: ${S.demog.wageNom.toFixed(3)}</div>
      </div>
    </div>`;
  document.getElementById('p-trade').innerHTML = `
    <div class="grid">
      <div class="card"><h2>é€šå•†</h2>
        <div class="mono">äº¤æ˜“æ¡ä»¶: ${S.trade.terms.toFixed(0)} / è¼¸å‡ºGDP: ${S.trade.x_gdp} / è¼¸å…¥GDP: ${S.trade.m_gdp}</div>
        <div class="mono small">ç›¸æ‰‹: ${Object.entries(S.trade.partners).map(([k,v])=>k+':'+(v*100|0)+'%').join(', ')}</div>
      </div>
    </div>`;
  document.getElementById('p-diplomacy').innerHTML = `
    <div class="grid">
      <div class="card"><h2>å¤–äº¤</h2>
        <div class="mono">é–¢ä¿‚: ${Object.entries(S.diplo.relations).map(([k,v])=>k+':'+(v*100|0)).join(', ')}</div>
        <div class="mono">è©•åˆ¤: ${(S.diplo.repute*100|0)} / Esc: ${S.diplo.escalation}</div>
      </div>
    </div>`;
  document.getElementById('p-risk').innerHTML = `
    <div class="grid">
      <div class="card"><h2>ãƒªã‚¹ã‚¯</h2>
        <div class="mono">ä¾›çµ¦åˆ¶ç´„: ${(S.supply.constraint*100|0)}%</div>
      </div>
    </div>`;
}
function renderLog(engine, prepend){
  const box=document.getElementById('log');
  const arr = prepend ? [prepend,...engine.S._log] : engine.S._log;
  box.innerHTML = `<div class="logbox">${arr.slice(0,60).map(x=>`<div>${x}</div>`).join('')}</div>`;
}

/* =========================================================
   5) çµ„ç«‹ & èµ·å‹•
========================================================= */
const eng = new Engine(countries[0].iso3);
[ new Prices(), new Energy(), new Macro(), new Demography(), new Trade(), new Geopolitics(), new Disasters(), new Climate() ].forEach(m=>eng.register(m));
initUI(eng); renderTop(eng); renderPanels(eng); renderLog(eng,"ready");

// PWA
if('serviceWorker' in navigator){ window.addEventListener('load', ()=>navigator.serviceWorker.register('service-worker.js')); }
</script>
</body>
</html>
